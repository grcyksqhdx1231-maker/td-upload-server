<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>User Videos</title>
  <style>
    body{font-family:system-ui;margin:24px;max-width:900px}
    a{color:#06c}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px}
    video{width:100%;max-height:260px;background:#000;border-radius:8px}
    .muted{color:#666;font-size:13px;word-break:break-all}
    code{background:#f5f5f5;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <p><a href="/">← 返回首页</a></p>
  <h1 id="title">用户档案</h1>

  <div class="muted">
    <div>读取到的 u 参数：<code id="u"></code></div>
    <div>请求 URL：<code id="req"></code></div>
    <div>返回条数：<code id="count"></code></div>
    <div id="err" style="color:#c00;"></div>
  </div>

  <hr/>

  <div id="list" class="grid"></div>

<script>
async function fetchJSON(url){
  const r = await fetch(url, { cache: "no-store" }); // 关键：避免缓存旧接口
  if(!r.ok) throw new Error(`HTTP ${r.status}: ${await r.text()}`);
  return r.json();
}
function fmtBytes(n){
  const u=["B","KB","MB","GB"]; let i=0;
  while(n>=1024 && i<u.length-1){n/=1024;i++}
  return `${n.toFixed(i?1:0)} ${u[i]}`;
}
function cardHtml(x){
  return `
    <div class="card">
      <div><b>${x.user}</b> <span class="muted">${x.style}_${x.skill}_${x.take}</span></div>
      <div class="muted">${x.filename} · ${fmtBytes(x.size)}</div>
      <video controls preload="metadata" src="${x.url}"></video>
    </div>`;
}

// ✅ 兼容两种参数名：u 或 user（防止你首页跳转写错）
const sp = new URLSearchParams(location.search);
const u = (sp.get("u") || sp.get("user") || "").trim();

document.getElementById("u").textContent = u || "(空)";
document.getElementById("title").textContent = u ? `用户：${u}` : "用户档案（缺少参数）";

if(!u){
  document.getElementById("err").textContent = "❌ URL 缺少参数：请用 /user.html?u=TEST";
} else {
  const reqUrl = `/api/user/${encodeURIComponent(u)}`;
  document.getElementById("req").textContent = reqUrl;

  (async ()=>{
    try{
      const data = await fetchJSON(reqUrl);
      document.getElementById("count").textContent = String((data.files||[]).length);
      document.getElementById("list").innerHTML = (data.files||[]).map(cardHtml).join("");
      if(!(data.files||[]).length){
        document.getElementById("err").textContent =
          "⚠️ 接口返回 0 条：请检查用户名大小写是否一致（比如 TEST vs test）。";
      }
    }catch(e){
      document.getElementById("err").textContent = "❌ 拉取失败：" + e.message;
      document.getElementById("count").textContent = "error";
    }
  })();
}
</script>
</body>

</html>
